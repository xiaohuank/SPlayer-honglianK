name: Weekly Nightly Build

on:
  schedule:
    - cron: "0 10 * * 5" # æ¯å‘¨äº” 18:00 (UTC+8)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0
      - name: Check for changes since last nightly tag
        id: check
        run: |
          BASE_VERSION=$(node -p "require('./package.json').version.split('-')[0]")
          LATEST_TAG="v${BASE_VERSION}-nightly"
          # æ£€æŸ¥ tag æ˜¯å¦å­˜åœ¨
          if git rev-parse "$LATEST_TAG" >/dev/null 2>&1; then
            # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æäº¤
            CHANGED=$(git log "$LATEST_TAG"..HEAD --oneline)
            if [ -z "$CHANGED" ]; then
              echo "should_run=false" >> $GITHUB_OUTPUT
              echo "No changes since last nightly build."
            else
              echo "should_run=true" >> $GITHUB_OUTPUT
              echo "Changes detected."
            fi
          else
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "Nightly tag not found, running build."
          fi

  sync-and-build:
    needs: check-changes
    if: needs.check-changes.outputs.should_run == 'true'
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0

      - name: Clean workspace on Windows
        if: runner.os == 'Windows'
        run: |
          Write-Host "ğŸ§¹ Cleaning workspace, node_modules, Electron caches, and pnpm store..."
          if (Test-Path dist) { Remove-Item -Recurse -Force dist }
          if (Test-Path out) { Remove-Item -Recurse -Force out }
          if (Test-Path node_modules) { Remove-Item -Recurse -Force node_modules }

          if (Test-Path "$env:LOCALAPPDATA\electron-builder") {
            Remove-Item "$env:LOCALAPPDATA\electron-builder" -Recurse -Force -ErrorAction SilentlyContinue
          }
          if (Test-Path "$env:LOCALAPPDATA\electron") {
            Remove-Item "$env:LOCALAPPDATA\electron" -Recurse -Force -ErrorAction SilentlyContinue
          }

          if (Test-Path "$env:USERPROFILE\.pnpm-store") {
            Remove-Item "$env:USERPROFILE\.pnpm-store" -Recurse -Force -ErrorAction SilentlyContinue
          }
      - name: Clean workspace on macOS & Linux
        if: runner.os == 'macOS' || runner.os == 'Linux'
        run: |
          echo "ğŸ§¹ Cleaning workspace, node_modules, Electron caches, and pnpm store..."
          rm -rf dist out node_modules ~/.cache/electron-builder ~/.cache/electron ~/.pnpm-store

      # æ‰§è¡Œåˆ†æ”¯åŒæ­¥
      - name: Sync dev-nightly branch
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # å¼ºåˆ¶åˆ›å»º/åˆ‡æ¢åˆ° dev-nightly åˆ†æ”¯
          git checkout -b dev-nightly
          # å¼ºåˆ¶æ¨é€åˆ°è¿œç¨‹
          git push -f origin dev-nightly

      # å¤åˆ¶ç¯å¢ƒå˜é‡æ–‡ä»¶
      - name: Copy .env file on Windows
        if: runner.os == 'Windows'
        run: |
          if (-not (Test-Path .env)) {
            Copy-Item .env.example .env
          } else {
            Write-Host ".env file already exists. Skipping the copy step."
          }
      - name: Copy .env file on macOS & Linux
        if: runner.os == 'macOS' || runner.os == 'Linux'
        run: |
          if [ ! -f .env ]; then
            cp .env.example .env
          else
            echo ".env file already exists. Skipping the copy step."
          fi
      # è®¾ç½® pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22.x

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2

      # macOSç‰¹å®šé…ç½®
      - name: Install LLVM on macOS
        if: runner.os == 'macOS'
        run: brew install llvm
      - name: Set Environment Variables on macOS
        if: runner.os == 'macOS'
        run: |
          echo "CC=$(brew --prefix llvm)/bin/clang" >> $GITHUB_ENV
          echo "AR=$(brew --prefix llvm)/bin/llvm-ar" >> $GITHUB_ENV

      # Linuxç‰¹å®šé…ç½®
      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install --no-install-recommends -y rpm libarchive-tools libopenjp2-tools
          chmod +x ./node_modules/app-builder-bin/linux/x64/app-builder || true

      - name: Install dependencies
        run: pnpm install

      - name: Generate Nightly Version
        id: version
        shell: bash
        run: |
          # è¯»å– package.json ä¸­çš„ version
          BASE_VERSION=$(node -p "require('./package.json').version.split('-')[0]")
          HASH=$(git rev-parse --short=7 HEAD)
          DATE=$(date +'%Y%m%d')
          # æ ¼å¼: 3.0.0-nightly.20240207.abc1234
          VERSION="${BASE_VERSION}-nightly.${DATE}.${HASH}"

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"

          # ä¿®æ”¹ package.json
          npm pkg set version=${VERSION}

      - name: Build
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            pnpm build:win
          elif [ "${{ runner.os }}" == "macOS" ]; then
            pnpm build:mac
          else
            pnpm build:linux
          fi
        shell: bash

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: update-assets-${{ matrix.os }}
          path: dist/*.*

  release:
    needs: sync-and-build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      discussions: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: dev-nightly # åˆ‡æ¢åˆ° dev-nightly åˆ†æ”¯
          fetch-depth: 0

      - name: Update Nightly Tag
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # è·å–åŸºç¡€ç‰ˆæœ¬å·
          BASE_VERSION=$(node -p "require('./package.json').version.split('-')[0]")
          TAG_NAME="v${BASE_VERSION}-nightly"

          # å¼ºåˆ¶ç§»åŠ¨ nightly tag åˆ°å½“å‰ HEAD (å³ dev-nightly çš„æœ€æ–°æäº¤)
          git tag -f $TAG_NAME HEAD
          git push -f origin $TAG_NAME

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Update Nightly Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å–åŸºç¡€ç‰ˆæœ¬å·å’Œ tag
          BASE_VERSION=$(node -p "require('./package.json').version.split('-')[0]")
          TAG_NAME="v${BASE_VERSION}-nightly"

          # 1. ç¡®ä¿ nightly tag å’Œ release å­˜åœ¨
          # å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå­˜åœ¨åˆ™å¿½ç•¥
          gh release create $TAG_NAME --prerelease --title "Dev Nightly Build" --notes "Auto generated nightly build" --target dev-nightly || true

          # 2. è·å–æœ€è¿‘æ›´æ–°æ—¥å¿— (ä»ä¸Šä¸€ä¸ª tag åˆ° HEAD)
          # æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬æ¯”è¾ƒ dev åˆ†æ”¯çš„å˜æ›´
          # å¦‚æœæ²¡æœ‰ tagï¼Œå°±æ˜¾ç¤ºæœ€è¿‘ 20 æ¡
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            NOTES=$(git log -n 20 --pretty=format:"- %h %s")
          else
            # æ’é™¤å½“å‰ tag æœ¬èº«ï¼ˆå®ƒå·²ç»æŒ‡å‘ HEADï¼‰ï¼Œæ‰¾å‰ä¸€ä¸ª
            if [[ "$LAST_TAG" == *"-nightly" ]]; then
               LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            fi

            if [ -z "$LAST_TAG" ]; then
               NOTES=$(git log -n 20 --pretty=format:"- %h %s")
            else
               NOTES=$(git log "$LAST_TAG"..HEAD --pretty=format:"- %h %s" | head -n 20)
               # æ·»åŠ æŸ¥çœ‹å®Œæ•´å˜æ›´çš„é“¾æ¥
               COMPARE_URL="https://github.com/imsyy/SPlayer/compare/$LAST_TAG...HEAD"
               NOTES="$NOTES\n\n[ğŸ” View full changes]($COMPARE_URL)"
            fi
          fi

          # æ„å»º Release Body
          {
            echo "> [!WARNING]"
            echo "> "
            echo "> è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„ Nightly æ„å»ºç‰ˆæœ¬ã€‚å®ƒå¯èƒ½åŒ…å« Bugï¼Œä»…ä¾›æµ‹è¯•ä½¿ç”¨ã€‚ä½¿ç”¨é£é™©è‡ªè´Ÿã€‚"
            echo ""
            echo "## è‡ªä¸Šæ¬¡æ„å»ºä»¥æ¥çš„å˜æ›´ï¼š"
            echo ""
            echo -e "$NOTES"
          } > release_notes.md

          # æ›´æ–° Release Body
          gh release edit $TAG_NAME --notes-file release_notes.md

          # 3. åˆ é™¤æ—§ Assets å¹¶ä¸Šä¼ æ–° Assets
          echo "Deleting old assets..."
          # è·å–å½“å‰ Release çš„æ‰€æœ‰ assets
          ASSETS=$(gh release view $TAG_NAME --json assets -q '.assets[].name')

          for asset in $ASSETS; do
            echo "Deleting $asset..."
            gh release delete-asset $TAG_NAME "$asset" -y
          done

          echo "Uploading new assets..."
          # æ•´ç† artifact æ–‡ä»¶åˆ° flat ç›®å½•
          mkdir -p upload_dist
          find artifacts -type f -not -path "*/artifacts/*" -exec cp {} upload_dist/ \;

          # æ’é™¤ unpacked æ–‡ä»¶å¤¹ (è™½ç„¶ find -type f åº”è¯¥å·²ç»æ’é™¤ç›®å½•ï¼Œä½†ä»¥é˜²ä¸‡ä¸€)
          # å¹¶ä¸”æ’é™¤éæ„å»ºäº§ç‰©
          gh release upload $TAG_NAME upload_dist/* --clobber
